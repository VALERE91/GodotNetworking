name: Compile GDExtensions

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          - os: windows-latest
            platform: windows
            arch: x86_64
          # Removed MacOS to avoid billing too much for it
          #- os: macos-latest
          #  platform: macos
          #  arch: arm64

    steps:
      # Checkout Code (Recursive is CRITICAL for libuv/godot-cpp)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setup Python (Required for SCons)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Install SCons
      - name: Install SCons
        run: |
          pip install scons

      # Linux Dependencies (Only needed for Linux runner)
      - name: Install Linux Deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libx11-dev libxcursor-dev libxinerama-dev libgl1-mesa-dev libglu-dev libasound2-dev libpulse-dev

      - name: Install D3D12 SDK (Windows Only)
        if: matrix.platform == 'windows'
        working-directory: engine
        run: |
          python misc/scripts/install_d3d12_sdk_windows.py
          
      # Compile GDExtensions
      - name: Compile GDExtensions
        working-directory: src
        run: |
          scons platform=${{ matrix.platform }} arch=${{ matrix.arch }} target=template_release -j2
      
      # --- Cache Logic for Godot Engine ---
      
      # We generate a hash based on the current commit of the 'engine' submodule.
      # If we update the submodule to a new Godot version, the hash changes, and we rebuild.
      - name: Get Engine Submodule Hash
        id: engine-hash
        shell: bash
        run: |
          echo "hash=$(git submodule status engine | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT

      - name: Cache Godot Engine
        id: cache-engine
        uses: actions/cache@v4
        with:
          path: engine/bin
          # Key includes OS, Arch, and the specific commit of the engine submodule
          key: godot-engine-release-v2-${{ matrix.platform }}-${{ matrix.arch }}-${{ steps.engine-hash.outputs.hash }}

      # --- Build Engine (Only on Cache Miss) ---
      - name: Build Godot Engine (Release Template)
        if: steps.cache-engine.outputs.cache-hit != 'true'
        working-directory: engine
        run: |
          echo "‚ö†Ô∏è Cache Miss! Building Engine from source..."
          scons platform=${{ matrix.platform }} arch=${{ matrix.arch }} target=template_release disable_path_overrides=no -j4

      # --- The "Warm Up" (Import Assets) ---
      # We run the EDITOR in headless mode just to let it scan the folder.
      - name: Import Project Assets
        shell: bash
        run: |
          echo "üì¶ Importing Assets..."
          
          if [ "${{ matrix.platform }}" == "windows" ]; then
            EDITOR="./engine/bin/godot.windows.editor.x86_64.exe"
          elif [ "${{ matrix.platform }}" == "macos" ]; then
            EDITOR="./engine/bin/godot.macos.editor.arm64"
            chmod +x $EDITOR
          else
            EDITOR="./engine/bin/godot.linuxbsd.editor.x86_64"
            chmod +x $EDITOR
          fi

          # --headless: Don't open a window
          # --editor: Run in editor mode
          # --quit: Exit as soon as import is done
          $EDITOR --headless --path game/ --editor --quit
          
          echo "‚úÖ Import Complete."

      # --- The Smoke Test ---
      - name: Run Smoke Test
        shell: bash
        run: |
          echo "üî• Starting Smoke Test..."
          
          if [ "${{ matrix.platform }}" == "windows" ]; then
            BIN="./engine/bin/godot.windows.template_release.x86_64.exe"
          elif [ "${{ matrix.platform }}" == "macos" ]; then
            BIN="./engine/bin/godot.macos.template_release.arm64"
            chmod +x $BIN
          else
            BIN="./engine/bin/godot.linuxbsd.template_release.x86_64"
            chmod +x $BIN
          fi

          echo "Running with: $BIN"
          
          # Run headless and quit immediately upon success
          $BIN --headless --path game/ --quit
          
          echo "‚úÖ Smoke Test Passed"
